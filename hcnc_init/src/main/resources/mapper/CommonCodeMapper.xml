<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hcncinit.CommonCodeMapper">
    <select id="selectMainList" resultType="map">
        SELECT cd AS grp_cd,
               cd_nm AS grp_nm,
               use_yn,
               grp_cd AS parent_grp_cd
          FROM tb_cd_mst
         WHERE del_yn = 'N'
           AND sort_no = 0
        <if test="searchUseYn != null and searchUseYn != ''">
           AND use_yn = #{searchUseYn}
        </if>
        <if test="searchKeyword != null and searchKeyword != ''">
           AND (cd LIKE CONCAT('%', #{searchKeyword}, '%')
            OR cd_nm LIKE CONCAT('%', #{searchKeyword}, '%'))
        </if>
         ORDER BY cd
    </select>

    <select id="selectDetailList" resultType="map">
        SELECT grp_cd,
               cd,
               cd_nm,
               sort_no,
               adinfo_01,
               adinfo_02,
               adinfo_03,
               adinfo_04,
               adinfo_05,
               use_yn
          FROM tb_cd_mst
         WHERE del_yn = 'N'
           AND grp_cd = #{grp_cd}
           AND cd &lt;&gt; grp_cd
         ORDER BY sort_no
    </select>

    <select id="detailCount" resultType="int">
        SELECT COUNT(*)
          FROM tb_cd_mst
         WHERE del_yn = 'N'
           AND grp_cd = #{grp_cd}
           AND cd &lt;&gt; grp_cd
    </select>

    <insert id="upsertMain">
        INSERT INTO tb_cd_mst
            (grp_cd, cd, cd_nm, sort_no, use_yn, del_yn, crt_by, upd_by)
        VALUES
            (#{parent_grp_cd}, #{grp_cd}, #{grp_nm}, 0, #{use_yn}, 'N', #{userId}, #{userId})
        ON DUPLICATE KEY UPDATE
            cd_nm = VALUES(cd_nm),
            use_yn = VALUES(use_yn),
            del_yn = 'N',
            upd_by = VALUES(upd_by)
    </insert>

    <insert id="upsertDetail">
        INSERT INTO tb_cd_mst
            (grp_cd, cd, cd_nm, sort_no,
             adinfo_01, adinfo_02, adinfo_03, adinfo_04, adinfo_05,
             use_yn, del_yn, crt_by, upd_by)
        VALUES
            (#{grp_cd}, #{cd}, #{cd_nm}, #{sort_no},
             #{adinfo_01}, #{adinfo_02}, #{adinfo_03}, #{adinfo_04}, #{adinfo_05},
             #{use_yn}, 'N', #{userId}, #{userId})
        ON DUPLICATE KEY UPDATE
            cd_nm = VALUES(cd_nm),
            sort_no = VALUES(sort_no),
            adinfo_01 = VALUES(adinfo_01),
            adinfo_02 = VALUES(adinfo_02),
            adinfo_03 = VALUES(adinfo_03),
            adinfo_04 = VALUES(adinfo_04),
            adinfo_05 = VALUES(adinfo_05),
            use_yn = VALUES(use_yn),
            del_yn = 'N',
            upd_by = VALUES(upd_by)
    </insert>

    <update id="deleteMain">
        UPDATE tb_cd_mst
           SET del_yn = 'Y',
               del_ts = NOW(),
               del_by = #{userId},
               upd_by = #{userId}
         WHERE grp_cd = #{parent_grp_cd}
           AND cd = #{grp_cd}
    </update>

    <update id="deleteDetail">
        UPDATE tb_cd_mst
           SET del_yn = 'Y',
               del_ts = NOW(),
               del_by = #{userId},
               upd_by = #{userId}
         WHERE grp_cd = #{grp_cd}
           AND cd = #{cd}
    </update>

    <update id="updateDetailSort">
        UPDATE tb_cd_mst
           SET sort_no = #{sort_no},
               upd_by = #{userId}
         WHERE grp_cd = #{grp_cd}
           AND cd = #{cd}
    </update>
</mapper>
